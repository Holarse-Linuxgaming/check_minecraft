#!/usr/bin/env python

"""check_minecraft: A plugin for Nagios3 or Icinga2 for monitoring the
status of as Minecraft server."""

__author__      = "Mark Rogaski"
__email__       = "mrogaski@pobox.com"
__copyright__   = "Copyright 2015, Mark Rogaski"
__license__     = "MIT"
__version__     = "0.1.0"

import argparse
import nagiosplugin
import logging

_log = logging.getLogger('nagiosplugin')

class MCServer(nagiosplugin.Resource):
    def __init__(self, address, port=25565):
        self.address = address
        self.port = port
        self.version = None

    def probe(self):
        _log.debug('using dummy data')
        players = 60
        limit = 64
        utilization = players / limit * 100
        return [nagiosplugin.Metric('online', True, context='status'),
                nagiosplugin.Metric('players', players, min=0, max=limit,
                                    context='slots'),
                nagiosplugin.Metric('utilization', utilization,
                                    context='utilization', uom='%')]


def main():
    argp = argparse.ArgumentParser(description=__doc__)
    argp.add_argument('address', metavar='ADDRESS',
                      help='hostname or IP address of the server')
    argp.add_argument('-v', '--verbose', action='count', default=0)
    argp.add_argument('-p', '--port', metavar='PORT', default=25565,
                      help='TCP port number of the server')
    argp.add_argument('-w', '--warning', metavar='RANGE', default='75',
                      help='return warning if load is outside RANGE')
    argp.add_argument('-c', '--critical', metavar='RANGE', default='90',
                      help='return critical if load is outside RANGE')
    args = argp.parse_args()
    check = nagiosplugin.Check(
        MCServer(args.address, args.port),
        nagiosplugin.Context('status'),
        nagiosplugin.ScalarContext('slots'),
        nagiosplugin.ScalarContext('utilization', args.warning,
                                   args.critical))
    check.main(args.verbose)

if __name__ == '__main__':
    main()

